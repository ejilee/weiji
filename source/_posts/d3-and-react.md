---
title: D3.js 와 React 를 접목시키는 법
author: Yeji
tags: [D3.js, React, DOM]
categories:
  - [React]
  - [D3]
date: 2020-06-09 11:15:47
---
어제의 블로그 포스트 이후로 고민을 좀 했습니다. 이 참에 D3를 배워볼까? D3.js - 오랫동안 배우고 싶었는데, 늘 적당한 사유가 없어서 미루던 라이브러리. 결국 자기전에 잠깐 깨작깨작 해보고... '음, 역시나 좀 더 배우고싶은데?' 라는 생각이 들어서 어제 포스트 끝자락에 잠깐 맨션 했던 글을 여기에 다시한번 정리해 봅니다.

# 문제 : DOM 조작은 누가 하나?

저도 D3+React 프로젝트들을 보며 궁금했던게.... React를 사용할 때, 특정 DOM이 생성되냐 마냐는 내가 정해주는 상태 값 등을 기반으로 React가 버추얼 DOM 이랑 비교해가면서 자체적으로 DOM을 만들고 없애고 하는 것이라, 오히려 그 과정에서 내가 직접 DOM을 조작하면 React 로직과 충돌하기 때문에 직접적인 DOM 조작은 '하지 말아야 할 일' 이라고 알고 있었단 말입니다. React의 '선언형' 성격과도 맞지 않고요.

그런데 D3 코드를 슬쩍 보면 마치 jQuery 처럼 DOM 요소를 선택하고 attr 속성을 조작하고 이런 게 보이죠. 그럼, 내가 본 저 간지나는 D3+React 프로젝트들은 React 안에 어떤 방식으로 D3를 담고있는걸까? 라는 의문이 듭니다. D3가 DOM 조작을 하는 것에 대해서 React는 가만히 있는 걸까? React 내 DOM 조작에 대해서 ref라는 걸 배운 거 같은데 이걸 쓰면 되나?

[Bringing Together React, D3, And Their Ecosystem](https://www.smashingmagazine.com/2018/02/react-D3-ecosystem/)

위 글을 3분의 1정도 내리면 'React And D3.Js' 라는 해딩 밑으로 React - D3 접목 방법 4 가지가 정리되어 있습니다. 각 방법의 쟁점은 DOM 조작 권한이 D3에게 치우치느냐, React에게 치우치느냐입니다. 저는 각 방법의 예시는 제공하지고 않고 장/단점 요약만 해보겠습니다. 예시 원하시는 분은 본문으로 고고~

## 방법 1 - React 안에 D3.js 그대로 담기

D3에게 최대한 많은 DOM 조작 권한을 주는 방법입니다. 랜더 매서드 안에 ref가 달린 텅 빈 svg 요소를 넣어놓고, componentDidUpdate 라이프사이클 매서드에서 D3 코드를 바닐라 자바스크립트에서 마냥 마음껏 쓰는 방법입니다. shouldComponentUpdate 라이프사이클 매서드에서 무조건 return false를 써 놓아서 React에 인해서 컴포넌트가 업데이트되는 것을 방지합니다.

### 장점

- 대부분의 경우 작동함
- 단순한 방법
- D3로 이미 만든 코드를 React로 옮길 때 크게 수정하지 않고 옮길 수 있음

### 단점

- 깨끗하지 않고, 코드가 무거워진다
- React의 선언형 근본과 반대된다

## 방법 2 - 가짜 DOM (React Faux DOM)

D3의 DOM 조작 방법을 사용하되, React 관리하에 있는 DOM 과 다른 가짜 DOM을 넘겨줘서 D3가 마치 진짜 DOM을 조작하고 있는 것 처럼 생각하게 만드는 방법입니다. 우선 react-faux-dom 패키지를 불러와서 prop을 가짜 DOM 과 연결시킨 후 D3 선택지를 랜더에 있는 요소가 아닌 가짜 DOM 과 연결된 변수로 선택해주고, 랜더 매서드 안에서는 해당 프롭을 보여주는 식입니다.


### 장점

- React가 사용하는 DOM 을 그대로 보존할 수 있다
- D3.js API 의 대부분 사용 가능
- 이미 만들어진 D3 코드 변환하기 쉬움
- SSR 가능

### 단점

- 성능 떨어짐 (이미 버추얼 DOM을 갖추고 있는 React에 비추얼 DOM을 하나 더 추가하는 무거운 일)

## 방법 3 - 컴포넌트 라이프라이클로 D3 매서드 감싸기

React 컴포넌트의 라이프사이클 매서드들을 사용해서 D3의 create / update / remove 를 감싸는 방법입니다.

### 장점

- React 컴포넌트를 더 가볍게 짤 수 있다
- 관심사분리 (separation of concerns)
- 차트 자체의 코드를 따로 숨기고 단순한 인터페이스 제공, 깔끔

### 단점

- SSR 불가능

## 방법 4 - DOM은 React에게, 계산은 D3에게

D3 사용을 최소화하는 방법입니다. SVG path 계산, scale, layouts, transformations 등의 선/도형등의 모양을 계산하는 것만 D3가 하게하고 나머지는 React에게 맡깁니다. 이게 가능한 이유는 D3가 많은 서브 모듀들로 이루어져있고, 이 중 DOM 조작과 상관없는 모듈도 상당수이기 때문입니다.

### 장점

- 가장 React-지향적
- 이미 있는 다른 React 코드와도 가장 잘 어울림 (React 개발자들이 제일 좋아하는 방법)
- SSR 가능, React Native 혹은 React VR로 넘길 수 도 있음

### 단점

- D3 에 대해 조금 더 자세하게 알아야함 (서브모듈들을 분리해서 사용해야 하기 때문에)
- D3 기본 요소들을 직접 작성해야함 (축, 도형은 쉬운편 / 브러쉬, 줌, 드래깅은 더 어려운 편) -> 초반부터 해야하는 일이 다른 방법보다 많을 거임
- 애니메이션도 다 React 단에서 해결해야함

# 결정

저는 다음 요점들을 고려해서 :

- 나는 기존에 있는 D3 코드를 사용하는게 아니다
- 애니메이션, 마우스 이펙트 등을 헤비하게 사용할 생각이 없다
- 무거운게 싫다
- svg 요소들 직접 쓰는 건 좋다

**'방법 4 - DOM은 React에게, 계산은 D3에게'** 를 선택했습니다.

제가 D3를 배우고싶다고 제일 처음 생각했던 건 예전에 Shirley Wu라는 분이 만든 데이터 시각화 작품들을 본 후였습니다. 자바스크립트로 그런 것들을 만들수 있다는게 놀라웠고, 그 이후로 나도 배우고 싶다는 생각은 늘 해왔는데... 마침 제가 자주보는 FunFunFunction이라는 채널에 게스트로 나와서 4분이서 d3, p3 등에 관해서 얘기하는 영상이 있더라고요. (아래 링크)

[Data visualisation chat about D3.js, P5.js, JavaScript, Python with kosamari, sxywu and shiffman](https://www.youtube.com/watch?v=Awnz8x8kcE8)

위 영상에서 35~36분 10초 사이에 셜리씨가 D3 진입 장벽에 대해서 얘기하는 부분이 있습니다. 정리하자면...

- D3 진입 장벽이 높은 이유는 초반에 enter/update/exit 에 대해서 배우는 것 때문
- React 를 사용하면 enter/update/exit 안 쓰고 D3로 계산하는 법만 알면 됨, 이 같은 DOM 조작 기능이 React에 이미 내장되어있기 때문에
- React 를 알면 D3 진입이 오히려 쉬울 수도 있음

그냥 배우는 것만을 목적으로 하면 또 튜토리얼 헬에 빠질 수도 있을 것 같아서. 실질적인 목적을 하나 세우고 공부를 시작하려고 합니다. 목적은 이번 주말까지 텃밭도우미에 있는 CropYear 컴포넌트를 svg와 D3 계산으로 다시 만드는 것.